<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TOSæƒé™æµ‹è¯•</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .test-section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }
        .success { color: green; background: #e6ffe6; padding: 10px; border-radius: 5px; margin: 10px 0; }
        .error { color: red; background: #ffe6e6; padding: 10px; border-radius: 5px; margin: 10px 0; }
        .warning { color: orange; background: #fff3cd; padding: 10px; border-radius: 5px; margin: 10px 0; }
        button { padding: 10px 20px; margin: 5px; cursor: pointer; }
        input, textarea { width: 100%; padding: 8px; margin: 5px 0; }
        .result { margin: 10px 0; padding: 10px; background: #f8f9fa; border-radius: 5px; }
    </style>
</head>
<body>
    <h1>ğŸ”§ TOSæƒé™è¯Šæ–­å·¥å…·</h1>
    
    <div class="test-section">
        <h3>1. æµ‹è¯•è§†é¢‘URLè®¿é—®</h3>
        <input type="text" id="videoUrl" placeholder="è¾“å…¥è§†é¢‘URL" 
               value="https://zhaoweibo-video-demo.tos-cn-beijing.volces.com/uploads/20251021_224945_60bb1786.mp4">
        <button onclick="testVideoAccess()">æµ‹è¯•è®¿é—®</button>
        <div id="videoResult" class="result"></div>
    </div>

    <div class="test-section">
        <h3>2. æµ‹è¯•TOSä¸Šä¼ </h3>
        <input type="file" id="testFile" accept="video/*">
        <button onclick="testTOSUpload()">æµ‹è¯•ä¸Šä¼ </button>
        <div id="uploadResult" class="result"></div>
    </div>

    <div class="test-section">
        <h3>3. æƒé™è¯Šæ–­</h3>
        <div id="diagnosis" class="result">
            <h4>ğŸ” è¯Šæ–­ç»“æœï¼š</h4>
            <div class="error">
                <strong>âŒ é—®é¢˜ç¡®è®¤ï¼šTOS Bucketæƒé™é—®é¢˜</strong><br>
                è§†é¢‘æ–‡ä»¶è¿”å›403 Forbiddenï¼Œè¯´æ˜Bucketæ²¡æœ‰å…¬å…±è¯»æƒé™ã€‚<br>
                è¿™å°±æ˜¯ä¸ºä»€ä¹ˆç«å±±å¼•æ“æ— æ³•è®¿é—®è§†é¢‘æ–‡ä»¶çš„åŸå› ã€‚
            </div>
            
            <h4>å¯èƒ½çš„é—®é¢˜ï¼š</h4>
            <ul>
                <li><strong>âœ… å·²ç¡®è®¤ï¼šTOS Bucketæƒé™é—®é¢˜</strong>ï¼šBucketæ²¡æœ‰è®¾ç½®å…¬å…±è¯»æƒé™</li>
                <li><strong>æ–‡ä»¶ä¸å­˜åœ¨</strong>ï¼šä¸Šä¼ çš„æ–‡ä»¶å¯èƒ½æ²¡æœ‰æˆåŠŸä¿å­˜</li>
                <li><strong>è·¯å¾„é”™è¯¯</strong>ï¼šæ–‡ä»¶è·¯å¾„å¯èƒ½ä¸æ­£ç¡®</li>
                <li><strong>è·¨åŸŸé—®é¢˜</strong>ï¼šCORSè®¾ç½®å¯èƒ½é˜»æ­¢è®¿é—®</li>
            </ul>
            
            <h4>è§£å†³æ–¹æ¡ˆï¼š</h4>
            <ol>
                <li><strong>ğŸ”¥ ç«‹å³è§£å†³ï¼šè®¾ç½®TOS Bucketå…¬å…±è¯»æƒé™</strong>ï¼š
                    <ul>
                        <li>ç™»å½•ç«å±±å¼•æ“æ§åˆ¶å°ï¼š<a href="https://console.volcengine.com" target="_blank">https://console.volcengine.com</a></li>
                        <li>è¿›å…¥TOSæœåŠ¡</li>
                        <li>æ‰¾åˆ°Bucketï¼š<code>zhaoweibo-video-demo</code></li>
                        <li>è¿›å…¥"æƒé™ç®¡ç†" â†’ "å…¬å…±è¯»æƒé™"</li>
                        <li>è®¾ç½®ä¸º"å…è®¸"å¹¶ä¿å­˜</li>
                        <li><strong>è¿™æ˜¯æœ€ç›´æ¥çš„è§£å†³æ–¹æ¡ˆï¼</strong></li>
                    </ul>
                </li>
                <li><strong>ä¸´æ—¶æ–¹æ¡ˆï¼šä½¿ç”¨é¢„ç­¾åURL</strong>ï¼š
                    <ul>
                        <li>å¦‚æœBucketå¿…é¡»ä¿æŒç§æœ‰ï¼Œéœ€è¦ç”Ÿæˆé¢„ç­¾åURL</li>
                        <li>é¢„ç­¾åURLæœ‰æ—¶æ•ˆæ€§ï¼Œéœ€è¦å®šæœŸæ›´æ–°</li>
                        <li>éœ€è¦ä¿®æ”¹ä»£ç ä»¥æ”¯æŒé¢„ç­¾åURL</li>
                    </ul>
                </li>
                <li><strong>æ›¿ä»£æ–¹æ¡ˆï¼šä½¿ç”¨å…¶ä»–äº‘å­˜å‚¨</strong>ï¼š
                    <ul>
                        <li>ä½¿ç”¨é˜¿é‡Œäº‘OSSã€è…¾è®¯äº‘COSç­‰</li>
                        <li>ç¡®ä¿æœ‰å…¬å…±è¯»æƒé™</li>
                        <li>æˆ–è€…ä½¿ç”¨CDNæœåŠ¡</li>
                    </ul>
                </li>
            </ol>
            
            <div class="warning">
                <strong>âš ï¸ é‡è¦æç¤ºï¼š</strong><br>
                ç«å±±å¼•æ“çš„è§†é¢‘ç¼–è¾‘æœåŠ¡éœ€è¦èƒ½å¤Ÿç›´æ¥è®¿é—®è§†é¢‘æ–‡ä»¶ã€‚<br>
                å¦‚æœè§†é¢‘æ–‡ä»¶æ— æ³•å…¬å¼€è®¿é—®ï¼ŒæœåŠ¡å°†æ— æ³•å¤„ç†è§†é¢‘å†…å®¹ã€‚
            </div>
        </div>
    </div>

    <script>
        async function testVideoAccess() {
            const url = document.getElementById('videoUrl').value;
            const resultDiv = document.getElementById('videoResult');
            
            if (!url) {
                resultDiv.innerHTML = '<div class="error">è¯·è¾“å…¥è§†é¢‘URL</div>';
                return;
            }
            
            resultDiv.innerHTML = '<div>æ­£åœ¨æµ‹è¯•è®¿é—®...</div>';
            
            try {
                const response = await fetch(url, { method: 'HEAD' });
                
                if (response.ok) {
                    resultDiv.innerHTML = `
                        <div class="success">
                            âœ… è§†é¢‘URLå¯ä»¥è®¿é—®<br>
                            çŠ¶æ€ç : ${response.status}<br>
                            å†…å®¹ç±»å‹: ${response.headers.get('content-type') || 'æœªçŸ¥'}<br>
                            æ–‡ä»¶å¤§å°: ${response.headers.get('content-length') || 'æœªçŸ¥'} å­—èŠ‚
                        </div>
                    `;
                } else {
                    resultDiv.innerHTML = `
                        <div class="error">
                            âŒ è§†é¢‘URLæ— æ³•è®¿é—®<br>
                            çŠ¶æ€ç : ${response.status}<br>
                            é”™è¯¯: ${response.statusText}
                        </div>
                    `;
                }
            } catch (error) {
                resultDiv.innerHTML = `
                    <div class="error">
                        âŒ è®¿é—®å¤±è´¥<br>
                        é”™è¯¯: ${error.message}
                    </div>
                `;
            }
        }
        
        async function testTOSUpload() {
            const fileInput = document.getElementById('testFile');
            const resultDiv = document.getElementById('uploadResult');
            
            if (!fileInput.files[0]) {
                resultDiv.innerHTML = '<div class="error">è¯·é€‰æ‹©æ–‡ä»¶</div>';
                return;
            }
            
            const file = fileInput.files[0];
            resultDiv.innerHTML = '<div>æ­£åœ¨ä¸Šä¼ æ–‡ä»¶...</div>';
            
            try {
                const formData = new FormData();
                formData.append('file', file);
                formData.append('bucket', 'zhaoweibo-video-demo');
                formData.append('region', 'cn-beijing');
                formData.append('access_key_id', 'YOUR_ACCESS_KEY_ID');
                formData.append('secret_access_key', 'YOUR_SECRET_ACCESS_KEY');
                
                const response = await fetch('http://localhost:8000/api/tos/upload', {
                    method: 'POST',
                    body: formData
                });
                
                const result = await response.json();
                
                if (result.success) {
                    resultDiv.innerHTML = `
                        <div class="success">
                            âœ… ä¸Šä¼ æˆåŠŸ<br>
                            æ–‡ä»¶URL: <a href="${result.url}" target="_blank">${result.url}</a><br>
                            <button onclick="testVideoAccess()">æµ‹è¯•æ–°URLè®¿é—®</button>
                        </div>
                    `;
                    // æ›´æ–°æµ‹è¯•URL
                    document.getElementById('videoUrl').value = result.url;
                } else {
                    resultDiv.innerHTML = `
                        <div class="error">
                            âŒ ä¸Šä¼ å¤±è´¥<br>
                            é”™è¯¯: ${result.error}
                        </div>
                    `;
                }
            } catch (error) {
                resultDiv.innerHTML = `
                    <div class="error">
                        âŒ ä¸Šä¼ å¼‚å¸¸<br>
                        é”™è¯¯: ${error.message}
                    </div>
                `;
            }
        }
        
        // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨æµ‹è¯•å½“å‰URL
        window.onload = function() {
            testVideoAccess();
        };
    </script>
</body>
</html>
